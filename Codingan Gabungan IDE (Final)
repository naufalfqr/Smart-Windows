#include "DHT.h"                    //Package Sensor DHT11
#include <Wire.h>                   //Package untuk komunikasi dengan perangkat I2C
#include <LiquidCrystal_I2C.h>      //Package penggunaan LCD 16x2 I2C
#include <Servo.h>                  //Package penggunaan Motor Servo


#define DHTPIN D7                   //Inisialisasi pin Sensor DHT11 (Suhu)
#define TAMPIL_SERIAL true          //Preprocessing Kondisional Bersyarat
#define DHTTYPE DHT11               //Inisialisasi Tipe DHT11
#define LDR A0                      //Inisialisasi pin Sensor LDR 

 
LiquidCrystal_I2C lcd(0x27, 16, 2); //Alamat I2C, jumlah kolom, jumlah baris
DHT dht(DHTPIN, DHTTYPE);           //Insialisasi Sensor DHT11


//Identifikasi Penulisan Derajat
const byte KARAKTER_DERAJAT = 0;    
byte derajat[] = {
  B00111,     //Simbol Derajat
  B00101,     //Simbol Persen
  B00111,     //Simbol Derajat
  B00000,
  B00000,
  B00000,
  B00000,
  B00000
};


//Pendefinisian Variabel
int hum = 0, temp = 0;              //Variabel untuk temperatur dan kelembaban
int ENA = 2;                        //Variabel inisialisasi pin ENA Motor Driver L298N
int IN1 = 14;                       //Variabel inisialisasi pin IN1 Motor Driver L298N
int IN2 = 12;                       //Variabel inisialisasi pin IN2 Motor Driver L298N
Servo myservo;                      //Variabel Servo


//Fungsi Khusus Motor DC
void motorDC() {
  
  //Pendeteksian cahaya melalui sensor LDR
  int valDC = analogRead(LDR);      //Variabel hasil deteksi cahaya  
  Serial.begin(9600);
  Serial.println(valDC);  


  //Proses cahaya ke output (Motor DC)
  int nilaiSensorDC;
  nilaiSensorDC = analogRead(LDR);


  //Kondisi proses cahaya ke output
  if(nilaiSensorDC <=200){
    digitalWrite(ENA, 80);      //Speed Control Pin
    digitalWrite(IN1, HIGH);    //Direction Control Pin (Forward)
    digitalWrite(IN2, LOW);     //Direction Control Pin (Forward)
  }
  else{
    digitalWrite(IN1, LOW);     //Mematikan Motor DC
    digitalWrite(IN2, LOW);
  }
}


void setup() {
//Kondisional Bersyarat
#if TAMPIL_SERIAL
  Serial.begin(9600);
  Serial.println(F("DHT 11 !"));
#endif


//Setup Bagian LCD 16x2
lcd.begin();
lcd.createChar(KARAKTER_DERAJAT, derajat);
lcd.backlight();
lcd.setCursor(0, 0);
lcd.print("TEMPERATUR :");
lcd.setCursor(0, 1);
lcd.print("HUMIDITY   :");


//Perintah memulai Sensor DHT11
dht.begin();


//Setup Bagian Motor Servo
myservo.attach(0);                  //Inisialisasi pin Servo pada pin D3 = 0 dari diagram
myservo.write(0);                   //Setup perintah penulisan ke Servo
delay(2000);


//Setup pin dari Motor Driver L298N untuk Motor DC
pinMode(ENA, OUTPUT);
pinMode(IN1, OUTPUT);
pinMode(IN2, OUTPUT);
}


void loop() {
  //Pendeteksian dari Sensor Suhu (DHT11)
  delay(2000);
  hum = dht.readHumidity();
  temp = dht.readTemperature();     // Proses pembacaan temperatur dalam celcius (default)


  //Kondisi Bila Nilai Tak Terbaca
  if (isnan(hum) || isnan(temp)) {
  #if TAMPIL_SERIAL
  Serial.println(F("Failed to read from DHT sensor!"));
  #endif
  return;
  }


  //Pengaturan Penempatan Hasil Perhitungan Suhu dan Kelembaban di LCD 16x2
  lcd.setCursor(13, 0);
  lcd.print(temp);
  lcd.setCursor(13, 1);
  lcd.print(hum);
  if(temp < 10){
    lcd.setCursor(14, 0);
  }else{
    lcd.setCursor(15, 0);
  }
  lcd.write(KARAKTER_DERAJAT);

  if(temp < 10){
    lcd.setCursor(15, 1);
  }else{
    lcd.setCursor(16, 1);
  }
  lcd.print("C");

  if(hum < 10){
    lcd.setCursor(14, 1);
  }else{
    lcd.setCursor(15, 1);
  }
  lcd.print("%");


  //Pengaturan Penempatan Hasil Perhitungan Suhu dan Kelembaban di Monitor
  #if TAMPIL_SERIAL
  Serial.println("\n================");
  Serial.print(F("Temperature: ")); Serial.print(temp); Serial.println(F("Â°C "));
  Serial.print(F("Humidity: ")); Serial.print(hum); Serial.println("%");
  #endif
  

  //Kondisi Pergerakan Servo berdasarkan Sensor Suhu (DHT11)
  if (temp >= 25){
  myservo.write(180); //Servo akan berputar 180 derajat
  delay(1000);
  }else{
  myservo.write(0);   //Servo akan kembali ke tempat semula
  delay(1000);
  }

  //Pemanggilan Fungsi Khusus Motor DC
  motorDC();
}
